# Детальное описание проекта AI Auto Debate

## Обзор проекта

AI Auto Debate - это веб-приложение для автоматических дебатов между двумя ИИ-ботами. Проект поддерживает два режима работы: бесконечные дебаты (последовательный режим) и синхронный диалог (параллельный режим). Каждый режим имеет независимую историю диалогов, отдельное окно чата и собственное логирование.

## Архитектура проекта

```
ai_auto_debate/
├── src/                    # Основной код приложения
│   ├── main.py            # Точка входа FastAPI приложения
│   ├── api/               # API эндпоинты
│   ├── core/              # Основная логика дебатов
│   ├── web/               # Веб-интерфейс
│   └── bots/              # Клиенты для ИИ-ботов
├── storage/               # Хранилище данных
├── logs/                  # Логи приложения
├── requirements.txt       # Зависимости Python
├── start_web.ps1         # Скрипт запуска для Windows
└── README.md             # Основная документация
```

## Детальное описание файлов

### 1. Основные файлы проекта

#### `src/main.py`
**Назначение**: Точка входа FastAPI приложения
**Функциональность**:
- Создание FastAPI приложения
- Настройка статических файлов и шаблонов
- Подключение API роутера
- WebSocket для системных логов
- Основные эндпоинты (/, /health)

**Ключевые компоненты**:
```python
app = FastAPI(title="Бесконечные дебаты")
app.mount("/static", StaticFiles(directory=static_dir), name="static")
app.include_router(api_router, prefix="/api")
```

#### `requirements.txt`
**Назначение**: Список Python зависимостей
**Содержит**:
- fastapi - веб-фреймворк
- uvicorn - ASGI сервер
- httpx - HTTP клиент
- jinja2 - шаблонизатор
- aiofiles - асинхронная работа с файлами

### 2. API слой (`src/api/`)

#### `src/api/routes.py`
**Назначение**: Определение всех API эндпоинтов
**Основные эндпоинты**:

1. **Состояние и управление**:
   - `GET /api/state` - общее состояние дебатов
   - `GET /api/state/mode1` - состояние режима 1 (бесконечные дебаты)
   - `GET /api/state/mode5` - состояние режима 5 (синхронный диалог)
   - `POST /api/mode` - переключение режимов
   - `POST /api/topic` - установка темы дебатов

2. **Сообщения и взаимодействие**:
   - `POST /api/message` - отправка пользовательского сообщения
   - `POST /api/interrupt` - прерывание текущих дебатов
   - `POST /api/step` - выполнение одного шага дебатов

3. **Очистка истории**:
   - `POST /api/clear` - очистка общей истории
   - `POST /api/clear/mode1` - очистка истории режима 1
   - `POST /api/clear/mode5` - очистка истории режима 5

4. **Настройки и конфигурация**:
   - `GET /api/connectivity` - проверка подключения к ботам
   - `POST /api/bot-urls` - обновление URL ботов
   - `GET /api/roles` - получение ролей ботов
   - `POST /api/roles` - сохранение ролей ботов
   - `GET /api/errors` - получение ошибок
   - `GET /api/logs-path` - путь к логам

### 3. Основная логика (`src/core/`)

#### `src/core/debate_manager.py`
**Назначение**: Основной менеджер дебатов
**Ключевые классы**:

1. **BotProfile** - профиль бота:
   ```python
   @dataclass
   class BotProfile:
       name: str
       url: str
       model: Optional[str] = None
   ```

2. **DebateState** - состояние дебатов:
   ```python
   @dataclass
   class DebateState:
       mode: int = 1
       topic: Optional[str] = None
       history: List[Dict[str, str]] = field(default_factory=list)
       moderator_enabled: bool = True
       sequential_mode: bool = True
       last_speaker: Optional[str] = None
   ```

3. **DebateManager** - основной менеджер:
   - Управление двумя независимыми состояниями (mode1 и mode5)
   - Подключение к ИИ-ботам через LMStudioClient
   - Координация дебатов между ботами
   - Логирование всех событий

**Основные методы**:
- `start()` - инициализация и запуск
- `set_mode()` - переключение между режимами
- `step_sequence()` - выполнение одного шага дебатов
- `add_user_message()` - добавление пользовательского сообщения
- `_ask_bot()` - запрос к ИИ-боту
- `connectivity()` - проверка подключения

#### `src/core/config.py`
**Назначение**: Конфигурация приложения
**Содержит**:
- URL ботов по умолчанию
- Альтернативные URL для fallback
- Пути к директориям (логи, промпты)
- Настройки логирования

#### `src/core/logger.py`
**Назначение**: Система логирования
**Функциональность**:
- Создание логгеров для разных компонентов
- Ротация логов
- Форматирование сообщений
- Отдельные логгеры для каждого режима

### 4. Веб-интерфейс (`src/web/`)

#### `src/web/templates/index.html`
**Назначение**: Главная страница приложения
**Структура**:

1. **Заголовок**:
   - Название приложения
   - Меню режимов (Бесконечные дебаты / Синхронный диалог)
   - Кнопки управления (Interrupt, Очистить чат, Открыть логи)

2. **Основная область**:
   - Вкладки чата для каждого режима
   - Контейнеры чата (chat-mode1, chat-mode5)
   - Поле ввода сообщений

3. **Боковая панель**:
   - Информация о ботах (статус, модель)
   - Системные логи
   - Настройки ролей и URL ботов

#### `src/web/static/style.css`
**Назначение**: Стили интерфейса
**Основные компоненты**:

1. **CSS переменные**:
   ```css
   :root {
     --bg: #0d0f14;
     --panel: #141824;
     --text: #e6e6e6;
     --accent: #6aa9ff;
     --bot1: #7bd88f;
     --bot2: #ff7ab2;
   }
   ```

2. **Стили вкладок чата**:
   - `.chat-tabs` - контейнер вкладок
   - `.chat-tab` - отдельная вкладка
   - `.chat-container` - контейнер чатов
   - `.chat` - отдельный чат с переходами

3. **Стили сообщений**:
   - `.msg.user` - сообщения пользователя
   - `.msg.bot1` - сообщения первого бота
   - `.msg.bot2` - сообщения второго бота
   - `.typing` - индикатор печати

#### `src/web/static/app.js`
**Назначение**: Клиентская логика интерфейса
**Основные функции**:

1. **Управление вкладками**:
   ```javascript
   function switchChatTab(mode) {
     // Переключение между вкладками чата
   }
   ```

2. **Загрузка состояния**:
   ```javascript
   async function pullStateForMode(mode) {
     // Загрузка состояния конкретного режима
   }
   ```

3. **WebSocket подключение**:
   ```javascript
   function connectLogs() {
     // Подключение к WebSocket для логов
   }
   ```

4. **Обработка событий**:
   - Отправка сообщений
   - Переключение режимов
   - Очистка чатов
   - Сохранение настроек

### 5. Клиенты ботов (`src/bots/`)

#### `src/bots/lmstudio_client.py`
**Назначение**: Клиент для подключения к LM Studio
**Функциональность**:
- HTTP запросы к API LM Studio
- Автоопределение модели
- Fallback на альтернативные URL
- Обработка ошибок и повторные попытки
- Кэширование информации о модели

**Основные методы**:
- `chat()` - отправка сообщения боту
- `check_connectivity()` - проверка подключения
- `_fetch_and_cache_model()` - определение модели
- `make_history_slice()` - подготовка истории для API

### 6. Скрипты запуска

#### `start_web.ps1`
**Назначение**: PowerShell скрипт для запуска на Windows
**Функциональность**:
- Активация виртуального окружения
- Запуск uvicorn сервера
- Обработка ошибок
- Автоматический перезапуск при сбоях

#### `install.ps1`
**Назначение**: Скрипт установки зависимостей
**Функциональность**:
- Создание виртуального окружения
- Установка Python пакетов
- Настройка окружения

### 7. Хранилище и логи

#### `storage/`
**Назначение**: Директория для хранения данных
**Содержит**:
- `prompts/` - промпты и роли ботов
- `roles.json` - сохраненные роли и ники

#### `logs/`
**Назначение**: Директория для логов
**Содержит**:
- Логи основного приложения
- Логи режима 1 (бесконечные дебаты)
- Логи режима 5 (синхронный диалог)
- Ротация логов по размеру и времени

### 8. Документация

#### `README.md`
**Назначение**: Основная документация проекта
**Содержит**:
- Описание проекта
- Инструкции по установке
- Примеры использования
- Описание режимов работы

#### `INDEPENDENT_CHATS_IMPLEMENTATION.md`
**Назначение**: Документация по реализации независимых чатов
**Содержит**:
- Детальное описание изменений
- Примеры кода
- Инструкции по использованию
- Преимущества реализации

## Режимы работы

### Режим 1: Бесконечные дебаты (sequential_mode = True)
- Боты отвечают по очереди
- Каждый бот получает полную историю диалога
- Автоматическое продолжение после паузы модерации
- Независимая история и логирование

### Режим 5: Синхронный диалог (sequential_mode = False)
- Оба бота отвечают параллельно
- Каждый бот работает с общей историей
- Одновременные ответы на одно сообщение
- Независимая история и логирование

## Технологический стек

- **Backend**: Python 3.8+, FastAPI, asyncio
- **Frontend**: HTML5, CSS3, JavaScript (ES6+)
- **WebSocket**: Для real-time логов
- **HTTP клиент**: httpx для запросов к ботам
- **Логирование**: Встроенный Python logging
- **Шаблоны**: Jinja2
- **Сервер**: Uvicorn (ASGI)

## Особенности реализации

1. **Независимые состояния**: Каждый режим имеет свое состояние
2. **Отдельные логгеры**: Каждый режим логируется отдельно
3. **Fallback механизм**: Автоматическое переключение на альтернативные URL
4. **Асинхронность**: Полностью асинхронная архитектура
5. **Модульность**: Четкое разделение на модули
6. **Масштабируемость**: Легко добавить новые режимы
7. **Отказоустойчивость**: Обработка ошибок и повторные попытки
8. **UX**: Плавные переходы и интуитивный интерфейс
